---
import { getImage } from "astro:assets";

interface Props {
  src: string;
}

const { src } = Astro.props;

// 处理 Obsidian 风格的路径
// 从 assets/2025-06-14.assets/我一直在哭.mp4 转换为 /blog/assets/2025-06-14.assets/我一直在哭.mp4
const videoPath = `/blog/assets/${src}`;

// 调试信息
console.log("Original src:", src);
console.log("Converted path:", videoPath);
---

<div class="video-container">
  <video
    controls
    crossorigin="anonymous"
    playsinline
    class="video-player"
    preload="metadata"
    x-webkit-airplay="allow"
    webkit-playsinline="true"
  >
    <source src={videoPath} type="video/mp4" />
    <p class="vjs-no-js">要观看此视频，请启用 JavaScript，并考虑升级到支持 HTML5 视频的 Web 浏览器</p>
  </video>
  <!-- 添加调试信息显示 -->
  <div class="debug-info" style="display: block;">
    <p>Original path: {src}</p>
    <p>Converted path: {videoPath}</p>
    <p>Full URL: {new URL(videoPath, Astro.url).toString()}</p>
    <p>Current URL: {Astro.url.toString()}</p>
    <p>Screen size: <span id="screen-size">检测中...</span></p>
  </div>
</div>

<style>
  .video-container {
    width: 100%;
    margin: 0;
    position: relative;
    overflow: hidden;
  }

  .video-player {
    width: 100%;
    height: auto;
    display: block;
    border-radius: 8px;
    overflow: hidden;
    background: #000;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
  }

  /* 平板设备 */
  @media (max-width: 1024px) {
    .video-container {
      width: 100%;
    }
  }

  /* 大屏手机 */
  @media (max-width: 767px) {
    .video-container {
      width: 100%;
    }

    .video-player {
      border-radius: 4px;
    }
  }

  /* 中等手机 */
  @media (max-width: 414px) {
    .video-container {
      width: 100%;
      margin: 0;
    }

    .video-player {
      border-radius: 0;
      width: 100%;
      height: auto;
    }
  }

  /* 小屏手机 */
  @media (max-width: 375px) {
    .video-container {
      width: 100%;
      margin: 0;
    }

    .video-player {
      border-radius: 0;
      width: 100%;
      height: auto;
    }
  }

  .debug-info {
    margin-top: 1rem;
    padding: 1rem;
    background: #f5f5f5;
    border-radius: 4px;
    font-size: 0.875rem;
  }
</style>

<script>
  // 添加移动端触摸控制支持
  document.addEventListener("DOMContentLoaded", () => {
    const videos = document.querySelectorAll<HTMLVideoElement>(".video-player");
    const screenSizeElement = document.getElementById("screen-size");

    // 更新屏幕大小信息
    function updateScreenSize() {
      if (screenSizeElement) {
        screenSizeElement.textContent = `${window.innerWidth} x ${window.innerHeight}`;
      }
    }

    // 初始更新
    updateScreenSize();

    // 监听窗口大小变化
    window.addEventListener("resize", updateScreenSize);

    videos.forEach((video) => {
      // 双击全屏
      video.addEventListener("dblclick", () => {
        try {
          if (video.requestFullscreen) {
            video.requestFullscreen();
          }
        } catch (error) {
          console.error("全屏请求失败:", error);
        }
      });

      // 触摸控制
      let touchStartX = 0;
      let touchStartTime = 0;

      video.addEventListener("touchstart", (e: TouchEvent) => {
        touchStartX = e.touches[0].clientX;
        touchStartTime = Date.now();
      });

      video.addEventListener("touchend", (e: TouchEvent) => {
        const touchEndX = e.changedTouches[0].clientX;
        const touchEndTime = Date.now();
        const deltaX = touchEndX - touchStartX;
        const deltaTime = touchEndTime - touchStartTime;

        // 快速滑动切换播放/暂停
        if (Math.abs(deltaX) < 10 && deltaTime < 300) {
          if (video.paused) {
            video.play().catch((error) => {
              console.error("播放失败:", error);
            });
          } else {
            video.pause();
          }
        }
      });

      // 强制移除内联样式
      video.removeAttribute("style");
    });
  });
</script>
